$hashes = @( "b75f163ca9b9240bf4b37ad92bc7556b40a17e27c2b8ed5c8991385fe07d17d0",
            "097549cf7d0f76f0d99edf8b2d91c60977fd6a96e4b8c3c94b0b1733dc026d3e",
            "2b6f1ebb2208e93ade4a6424555d6a8341fd6d9f60c25e44afe11008f5c1aad1",
            "65149e036fff06026d80ac9ad4d156332822dc93142cf1a122b1841ec8de34b5",
            "511df0e2df9bfa5521b588cc4bb5f8c5a321801b803394ebc493db1ef3c78fa1",
            "4edc7770464a14f54d17f36dc9d0fe854f68b346b27b35a6f5839adf1f13f8ea",
            "811157f9c7003ba8d17b45eb3cf09bef2cecd2701cedb675274949296a6a183d",
            "1631a90eb5395c4e19c7dbcbf611bbe6444ff312eb7937e286e4637cb9e72944",
            "207e3e756adf8c644248b8c84e3416f0e8aea41033298a6e88f19038698f04b8",
            "e2e2e0c556ba522f3db1ea8cd16e8258e58d4135f70cc0b4df1bd89fc1ba08c5",
            "322942b562d1154c8eae68f4a4a57863ac26f658365501e1d0cf88d25808c409",
            "771c27aec73f234a943adeacbc43531441a48dcc049c1b809d9d90e6f4f564c4",
            "627c4090a24035452ec67be38c612e41ffcf749bce543170c11838068f1fd2b6",
            "a5afaba0e6dff35e033dc3efbf3da3ed1cb4ae38b77e58c48e6650e417950d6e",
            "6ff84775fcf0a740cda78f456fd742df2b3eb54cb5af9fbfa4486b96335985cb",
            "d9a49ebd587aab8df1ce107a78abb7b9ba3f9a52c8f5fdd629a1307fc3b5938e",
            "0521bf5a035414f5981d53dec986c15c507651f70069431ca9a062b1d8bfbf3c",
            "fe66daf1a0d4d29aaa56ac5c247a56f6da24d09ddf8ee99d3751ee8569dc882e",
            "902753e77aa665785fe23e352dfdce510c59d3f6c5c8c5be5c364afd661aee59",
            "0ecd53fc8d302d97cda5a4527e8a59e961a748f811e86992bb65a575b1657019",
            "337d55256b118f766d0856610a00086e175d269e61cd2408322c1dba859627fd",
            "d9f1ac56a7e504efe117a25c507a8e45a4df9c8ff518b269f0c6c8df2f74452b",
            "4a0d30423e7657d73241c4e2a1dd8b3267195335335f8f98265668024110d809",
            "81e0ba840843c09dd132881f1efe155c2b7b4292bdff06806bd57ea83cac09a1",
            "028e17ed17a79431d0ec4660c239611f1ab53db6a10dc10296a9637f2395c902",
            "c6086766ef3238f6b744f8e1d5ad46633e6e502eff0bf3f08572ba4dde711140",
            "d898f69d23d05e8a7eb79fe569e105b5edb032170a0061872c337c3806a6c429",
            "6a14928fa13b98b402dc8011a66063dd0be46ab17392782ab9efeb09b8159b82",
            "a9144ad79cf88b8c88889894ea44a3b570f42aea05419e3f694fa200b2d7fdb5",
            "27b7ec1ec823e8f1aa83955ca47675f87ea0a11754cd15f49f9cf2ee4cb4d7b6",
            "a116fcf15668bafdfd032f4d4a5d10f28530f1263f637cea3f6ba0f8909d6515",
            "c54df5f1f1a970e451505c7c1331276cd830d8d9eaa2bc21d5fa8bfb9ca62236",
            "d3b84064755e9fd66da16b2b432fde91d8b72c49f134216685aa0bbc1e78a8e8",
            "5b849a58ecc5df580228d588e3e759b398bd4ec0fca594eafc586467e0a4b718",
            "6567aed279c5ef9e735b7d0eafb595a52c13c1ddaa6bdc231eba81de458590d9",
            "fdeeed57817845bff45fdf00d111066e565f54e00d831bbdac8f72ddc53de3b1",
            "13de3153c7bab7d5f9dc8c76b8c7a3fda68fe98028e388de6cb535a7dd8abee2",
            "3daee9db82beb15fd6fa5259166e8cb753ec26b54122d804bcc8c0b44b0c751c",
            "3058c0c13ee5db0771b224c51d299b9b4360297198a0409b5d1edd5854ac3922",
            "191365270d16896251d6476310e7286a42ce61f00dc3d6c77927f139d4cfc3d6",
            "638357280f149d2d525d449b1e65eb8ac94bef7d7a0478fbf9f6e277e4625a92",
            "a2628f12beaf13a4323066e08e20efd77eca2d5c80ad0cfc2117f0e6e9a0dc7a",
            "8e8ca2470c2d93710e1c1c90ba133e2ac4113e6ebd6f64ab3a1eb8898f0ea3c5",
            "47d5426b82b9d3876928ce301fdabc10ba59c424fc3cddc022d8ef8f2a131c17",
            "76a2a2e47e9830518a32989d96f8a939cc86dae4bc265cdc7aaff22a43a3c08e",
            "76feaa1efda58a299f44da8cce972ef3b3f0a9559ae716bdc1d2f7f5d059b5ce",
            "e75032305d99807e04c95f8b64fd2c5894726f9202b290c3a0bb2230040330bc",
            "f9902fc1249593fba0f6820eb92e27d34af1a37f1094a3d6372ed29d298fde5b",
            "004d6324d54edcacb9ab0c724f76105520566d36f010649219d72cd3bfd0a2e9",
            "ebebff5d8deabf31a9f8970c84febde2bc6dedf26f865fd0550e667bcbbb0d24",
            "d0f4f26e59148f406f92674e6a8dea66897e93f518bf4e7ac6944ac7bcb4e436",
            "1a97637475bd821bbf328e7a34b95b75842c4cc3f5c948eb059963b46fab7f28",
            "a044844db4f22fb43fe029c5101ffae924ad233bd6735489898aaaf85826a75d",
            "f0b1eb07a934c52b542d3d19a713be2047ba34f6b91252c8b3c9a6513c39f6d7",
            "1f9980e70043ce300f0769ca6ba8bdca717086cc99af06d40f2253b950591069",
            "6437167da44fbfc7cf2106950c6e7c89b87d6a4596d78027a00c7239f5719105",
            "debcca6f3713ac51db99d74abfe7dc1ab7d5f9e5fb54bddff3a3ed7fb6c15362",
            "2aac70501fbff235625830c91406d82839a3d1c00db1f7a6d6ed069b4794b99a",
            "ca8a8411dd2229bf28d36faddf787ea4b519ab6a04eec49d9b72800726d2c91c",
            "a71884bbf636465885596d9cfb83378b03b789e57824b07dabe2c1072e291f77",
            "33fba183e73003ab0ed1c2aae528d2cd7ceb81fc82c00610d6e56b5b5755c5be",
            "9bd73855afa6a758dbcc5dbb5615a00f893b387d55e7b08ed539ddd13e5e8c70",
            "206c471cbd342b0a740c28aff021e2e2a762850a51a1014205995bb506cc0839",
            "b96244959e451cd14e4bc7f8043334e9aa84366911f86210fb38615a7182f116",
            "87974a219cef3fde5863a71ec7854fd21a6ac612ea2bcc4045dd0759689586e0",
            "d60d74aeef0454285271559beba949d09f3ab1b28369e5c258a95c1c8a41002f",
            "d754807989cee92945255aa82a52664920046d2ee309301fe44401777bd99bf6",
            "3cdc7313553947f62b19b11a375c3418b8850e20e1c8492575d4aedfa01d9c43",
            "a576caf51845a1931d5c49973afe217ac982764b8d322ac9dd0edf2801287340",
            "0c8638ca7bc5a68974edd5ce81fac5685b77ec4a893a6de018ac2e3a033ab642",
            "f9d4aaa62d7b08bc861b5f6f04343e138a75a1549055b600914aab5d71506a97",
            "0f269f2fde99e69c905a23b2bdb12978f89535cf5e8b4766854686c42c25713f",
            "79ea3e2be9e7d8b31476f26c74084d1d53fbeb213dd2d0c229d357725551f5d6",
            "301d31be1008ceb23662ab5157154829e7a1b0dc13865b7b8a9896d4acbcfde2",
            "97460f7f5c065e1c394a14591858780ab2d92239c75e1395df8903bf9faf25a6",
            "95965c3e36ec7f57a624248bafca48f157dd1b4e38b0eb0f6e3f4fed78260609",
            "9aec79db9e9be45b7569af97db98a99de7caa2ee7a8e073c5d9e7e86c8560284",
            "b734764e1f28d7b2c09a8bfff006baa49dadb11f5b13163ba8fcc1fe9da5f463",
            "26b07de44cfc37112c0848841ddb6daa58edba923d0f32f195b2a9a582015387",
            "9c67656fc280f20604b4a6f20a2c4810536bf7b507d507ec25903dff66aa6654",
            "575e194d771fa606e7b434ee812a43f18cd6c7b687217b418f20b5b57480c7b6",
            "9ade79d05fb03a0d8dd270d1e69cabd7ddba0c28a089fe48ef965ecdce820c22",
            "ab3579115638859e292baa6fa117fdddaf26f42dfafc6f88c4cd1b65b5ec4c5b",
            "49c38413fd551dea76c0e6fe93f494cd397f317067bef45f2d00ae08f50ecc2e",
            "6d13877d0ea14b55aff924d596c7e2cce2a34ebd8022457bea9e1827d9fc7d1f",
            "a72d58b1e8f0aeeac77a49051fb147130b363eae438327350dfcc59b29296201",
            "33192934eb8c2adb90ce5b28132e7556aad2878d610b2bb7efb384c396328e75",
            "cf586a2e3a8e4b27cd0b2fa2c4fc382610118c7097eb083ea827a8c6914b8d6f",
            "10752e26c4ee2eecfe03615266253f9c82f0d59357483f3619a0772e1dc5ea0e",
            "655ce2fdcc482fc58c81dc082e7e7a2dbe923f8bf18b665f6fedc44d746d1b91",
            "d434d015471405d618e20178f7a83ef541fca01a6d307f4853c4251f8aa30001",
            "ebd7697d22f749ec547ba14ced2a880e1775a04475138c00ba82bee70c687a0a",
            "440951aac5604f730dbd9b5f6d028ec77efd8f7d343f9f593c714075d7c927f5",
            "4db73fd2ace1f29b14d0d36fb19cf619fb571371ba37f366ee7b55aa755d07b5",
            "8a4169b608fcf01b7b70b5a1d50220b9d6d65ec07affe1083a76ee6b043558a0",
            "8637860ec236ba7a672c3067909e336b716dada9efe149589793f05958862f4a",
            "6e091d8ba82673d1f7969e0e4166d90597785bbe59ba53712c513c7eeb5047b7",
            "8fcecb4b02af03e3de0ba834b7ffbe432a8e595645d3b62a4927a0a070b59272",
            "9b6ea1f6447e15b4d4899be2b8db0a9dfda5c1f23b23b0b9de1eaee761deb7d8",
            "5d054db1208c58c4d33ba2615c9af68f611f95117fb8f58872d4a1de34889ef5",
            "33a5233043349d0c763fe48e3cc790924fde2935f5a15f8fcc3738634acf2401",
            "2ec43e3e9058f849a075d64c44652ac265bf735efca1a638abcd6b6b0b50d5d6",
            "82bd3301a4bd6199f96b9e3eeab569b5787b48c8a33fa60fb3651680f959f92b",
            "002b3ead6e749013a62ec85a7ffea18c57337bd712a7e06366385b42d3560042",
            "4bf8efdf609d1c7e864495b1cad75751f10e50c9b273326071ed0561f3874959",
            "3629d46109b4f4b73a1ce5b0c6d07645cf332a4d8aae4f8fa4339ac79ce6890e",
            "002b3ead6e749013a62ec85a7ffea18c57337bd712a7e06366385b42d3560042",
            "79c7ea6179bf0a05d83bef75b72c6b427ccac3fa4d9511c9c184c1a7cf0828e4",
            "e47b9b9fe1b82d3c21164da31b06ea0cf8050a4f58964386a05319e9016e886f",
            "a2c4c07ca17476b466c6ef73b2437a54640796a7fb54e2545d65245b19dac4fd",
            "82bd3301a4bd6199f96b9e3eeab569b5787b48c8a33fa60fb3651680f959f92b",
            "44f87d55748550a205e02bbe6c5bcabd980d7c76c31bc499367074ccd24cb79d",
            "ebf6799bb86f0da2b05e66a0fe5a9b42df6dac848f4b951b2ed7b7a4866f19ef",
            "5f0480035ee23a12302c88be10e54bf3adbcf271a4bb1106d4975a28234d3af8",
            "06440942ba9e133316eee5961f0b420c542bde09155470b7beb367c940f6d489",
            "81a529c6deafbd9dcfdfd06d3b8200b9cdd2e394fe96765dd944994c9953d578",
            "a8fb6cb1e74101aba6ad843ce9a776792cdd9810a5e9da828a4004f8bdefcc16",
            "68e353208bdf8176074673c4845ace93ea6268b5a436c2fdda62a4371ed618ee",
            "830acfb044e4e4d767c2bcc0efe0aba1e35e8588a393afeb0dbfdd49be872863",
            "228197d31159eda5394316dc442a531c4c9876ef4cd1b0f51846130bc5557003",
            "0e501359f22f3eecc7f20951ff127275a95797401b137d4ad5b59069245daaa1",
            "111142d2db03e703f4a53d01a69ec9da0740726b2f4e0d39b4bc63f86783be49",
            "24f8217b17906331a4383599a24867d22e6fdb7b507201cd2f71cf0ff82e76e7",
            "b75f163ca9b9240bf4b37ad92bc7556b40a17e27c2b8ed5c8991385fe07d17d0",
            "2657e654feb960d560d1d8a82f6d4232fd6185a6c44e49a66c70977a70819b4d",
            "e8ea17cd1de6d3389c792cce8c0ff1927a6386f0ef32ab0b097763de1f86ffc8",
            "a80c9fe7df1f9bbfd1186f6f0d1a6785a462d320a4148267e3066af4a577a9ab",
            "c73a96319c82b310499c2ecb95a1468932662cee5380b65e0c9efaf1cd124df5",
            "ed408d3c2f99c9b3439bf444363548bd2af75d915447961269517b188d2d09b0",
            "c762292615f3ed4952913b735ec665ad7c3a4053b356c5781129f1ab8f0fe044",
            "c7e2e29e7a689bec0121994aafd7e00d2f42792cee07bb3cbc7910cc0b0183a9",
            "ba9db35004ce5d0e82d6f3984ec14ad31cf3c536834a08997166658ea44e68ed",
            "f92d165563573276a978091601500707160708b070cd01a69f89729f8cfca9eb",
            "bffa67eb796c6adbac3993584775a3144c230713342d121d0139a2586480df2d",
            "c6a1eb5314dbb6a1506056afaee22494176f8e5711be5974c9a5fee648f87675",
            "b8bb49c642628f312adb6cfafeb86f0b712d0d215dfbd334178710253a41ef61",
            "cbad57add30d38e943fed98b361c89f52000abcb05e9df49467e70c9e7f78eac",
            "6e75bbcdd22ec9df1c7796e381a83f88e3ae82f5698c6b31b64d8f11e9cfd867",
            "971223ad4141a7e0f0ac9c77c52e0db43ad5468691a58db12f39c27a69dc8c50",
            "9864cc06f6778a96dea6b18eb442832e4f9fb7da326e20b9dabab273a293229a",
            "9798f9e3d54b3780dd07b8d1b95d9f02288ccd050fde01c4d6ff129230e92977",
            "7edeab1ffcac172b72b4a406eed67b341c5988a5494285b42f5b8f0dd4d0046f",
            "73835edae7668cc99b98b88e047597cecec4f476cbd6804e843e738533299f9e",
            "9a66d6a8510736a55d3f3b9ae7e4456e767ff123ff940429fcd57b2bebfc6055",
            "9f3b53176abc86aef3c6b2434c7b01a7c3f17ba8db7e8be5f338a15073a2d6ca",
            "5f81fff9e6fc7946736d8883b835510b271b9981e459d36e47e777848b500cc1",
            "577a9f10b638ad22c6049ae6e56c28420e165899e33a5faa99317186a5a23cc1",
            "5d593f11623f6a1e562a911ec138aad1b85c0c055eb8d04b02ccbe57d6854604",
            "659863d84cf8cdf764f505c4daf3a39d8be0ce38aaee357f3e3c2c58babe0afd",
            "6e149e6bad1cef8aa84dc3b570542052cea97436a41221fc1be7f744ead700db",
            "5258d0fa5b5c8b04027600ce2b68d1ccc69e516829aba4969951770baa65ffd0",
            "8984f4a87a70eb223ab93a05948c669e600de5699714b338f63fe6571decd48b",
            "bd2f76512dd3881f131c9ade3275e0fbf86a080acd7493482d4f30f82b61e1ae",
            "62842cffd1c663ac2b2abe85a9fd482fcffc1c2e0683d1a536d8791b9f99cd3b",
            "173ac2a1f99fe616f5efa3a7cf72013ab42a68f7305e24ed795a98cb08046ee1",
            "406b680edc9a1bb0e2c7c451c56904857848b5f15570401450b73b232ff38928"
            )
$filePaths = @(  "C:\inetpub\wwwroot\aspnet_client\",
                "C:\inetpub\wwwroot\aspnet_client\system_web\",
                "c:\Program Files\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\owa\auth\",
                "c:\Program Files(x86)\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\owa\auth\",
                "C:\Exchange\FrontEnd\HttpProxy\owa\auth\")

Write-Host "Checking for Webshells"
foreach($filePath in $filePaths){
    if (Test-Path $filePath){
        cd $filePath;
        ls | % {$hash = Get-FileHash $_.Name; if ($hashes -contains $hash.Hash) { Write-Host $hash.Path}}
        ls | % {if ($_.Name.Contains(".aspx")) { $fileContent = Get-Content $_.Name; if ($fileContent.Contains("Jscript") -or $fileContent.Contains("<%System.IO.File.WriteAllText(Request.Item[`"p`"],Request.Item[`"c`"]);%>")) {Write-Host $_.Name} } }
    }
}

#CVE-2021-26858
Write-Host "Checking CVE-2021-26858 IOC"
findstr /snip /c:"Download failed and temporary file" "%PROGRAMFILES%\Microsoft\Exchange Server\V15\Logging\OABGeneratorLog\*.log"
#CVE-2021-26857
Write-Host "Checking CVE-2021-26857 IOC"
Get-EventLog -LogName Application -Source "MSExchange Unified Messaging" -EntryType Error | Where-Object { $_.Message -like "*System.InvalidCastException*" }
#CVE-2021-27065 
Write-Host "Checking CVE-2021-27065  IOC"
Select-String -Path "$env:PROGRAMFILES\Microsoft\Exchange Server\V15\Logging\ECP\Server\*.log" -Pattern 'Set-.+VirtualDirectory'
#CVE-2021-26855
Write-Host "Checking CVE-2021-26855 IOC"
Import-Csv -Path (Get-ChildItem -Recurse -Path "$env:PROGRAMFILES\Microsoft\Exchange Server\V15\Logging\HttpProxy" -Filter '*.log' -ErrorAction SilentlyContinue).FullName | Where-Object {  $_.AuthenticatedUser -eq '' -and $_.AnchorMailbox -like 'ServerInfo~*/*' } | select DateTime, AnchorMailbox
